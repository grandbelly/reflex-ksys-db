version: '3.8'
services:
  rpi-finished-pgai-db:
    build:
      context: ./20251030-rpi-pgcron
      dockerfile: Dockerfile.rpi-pgcron
    container_name: rpi-finished-pgai-db
    environment:
    - POSTGRES_USER=postgres
    - POSTGRES_PASSWORD=postgres
    - POSTGRES_DB=postgres
    - TIMESCALEDB_TELEMETRY=off
    - TZ=Asia/Seoul
    ports:
    - 5432:5432
    volumes:
    - pgai_data:/var/lib/postgresql/data
    - ./backup:/backup
    - ./migrations:/migrations
    networks:
    - ksys-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  rpi-finished-reflex-app:
    build: .
    container_name: rpi-finished-reflex-app
    ports:
    - 14000:14000
    - 14001:14001
    environment:
    - DOCKER_ENV=true
    - DB_TARGET=pgai
    - TS_DSN=postgresql://postgres:postgres@rpi-finished-pgai-db:5432/ecoanp?sslmode=disable
    - POSTGRES_CONNECTION_STRING=postgresql://postgres:postgres@rpi-finished-pgai-db:5432/ecoanp?sslmode=disable
    - APP_ENV=development
    - TZ=Asia/Seoul
    - VERSION_TYPE=FULL
    - ENABLE_AI_FEATURES=true
    volumes:
    - ./ksys_app:/app/ksys_app
    - ./rxconfig.py:/app/rxconfig.py
    - ./logs:/app/logs
    networks:
    - ksys-network
    depends_on:
      rpi-finished-pgai-db:
        condition: service_healthy
    restart: unless-stopped
    command:
    - reflex
    - run
    - --env
    - prod
    - --backend-host
    - 0.0.0.0
    - --frontend-port
    - '14000'
    - --backend-port
    - '14001'
    - --loglevel
    - debug

  rpi-finished-forecast-scheduler:
    build:
      context: .
      dockerfile: Dockerfile.scheduler
    container_name: rpi-finished-forecast-scheduler
    environment:
    - DOCKER_ENV=true
    - DB_TARGET=pgai
    - TS_DSN=postgresql://postgres:postgres@rpi-finished-pgai-db:5432/ecoanp?sslmode=disable
    - POSTGRES_CONNECTION_STRING=postgresql://postgres:postgres@rpi-finished-pgai-db:5432/ecoanp?sslmode=disable
    - TZ=Asia/Seoul
    volumes:
    - ./ksys_app:/app/ksys_app
    - ./saved_models:/app/saved_models
    - ./logs:/app/logs
    networks:
    - ksys-network
    depends_on:
      rpi-finished-pgai-db:
        condition: service_healthy
    restart: unless-stopped

  rpi-finished-data-injector:
    build:
      context: .
      dockerfile: Dockerfile.data-injector
    container_name: rpi-finished-data-injector
    environment:
    - DB_HOST=rpi-finished-pgai-db
    - DB_PORT=5432
    - TZ=Asia/Seoul
    networks:
    - ksys-network
    depends_on:
      rpi-finished-pgai-db:
        condition: service_healthy
    restart: unless-stopped

  # Cloudflare Tunnel - same as local ksys (uses ksys.kr domain)
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-tunnel
    command: tunnel --no-autoupdate run --token eyJhIjoiMDQwMzY4ZDNlZjZjOThjYzY1OTllMTljNGVmZDkyNDEiLCJ0IjoiMDk2NjcxNDQtZDI3NC00NzYzLTg4OWUtZjkzZmNlM2NiZDYzIiwicyI6Ik1USTBNMkkxTm1FdFpEWXhOaTAwT1RZNExXSXdOREV0T1RBMU9ERXlPRFpqWW1RNCJ9
    networks:
    - ksys-network
    restart: unless-stopped
    depends_on:
    - rpi-finished-reflex-app

networks:
  ksys-network:
    external: true
volumes:
  pgai_data:
    driver: local
